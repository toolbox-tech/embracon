name: ðŸš€ Bump Version and Generate Changelog (Commitizen)

on: 
  workflow_dispatch:
    inputs:
      increment:
        description: 'Increment type (auto/major/minor/patch)'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto
        - major
        - minor
        - patch
      dry_run:
        description: 'Dry run (no changes will be made)'
        required: false
        default: false
        type: boolean

jobs:
  bump-version:
    runs-on: ubuntu-latest
    name: "ðŸš€ Bump version and create changelog with commitizen"
    steps:
      - name: ðŸ“¥ Check out
        uses: actions/checkout@v4
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          fetch-depth: 0
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ðŸ“‹ Check if config exists
        run: |
          echo "Checking for Commitizen configuration..."
          if [ -f "pyproject.toml" ] && grep -q "tool.commitizen" pyproject.toml; then
            echo "âœ… Found pyproject.toml with Commitizen config"
          elif [ -f ".cz.toml" ]; then
            echo "âœ… Found .cz.toml config"
          else
            echo "âš ï¸ No Commitizen config found, creating minimal setup..."
            cat > .cz.toml << EOF
          [tool.commitizen]
          name = "cz_conventional_commits"
          version = "1.0.0"
          tag_format = "v\$version"
          changelog_file = "Secret Management/infra-secrets/CHANGELOG.md"
          changelog_start_rev = "v1.0.0"
          bump_message = "bump: version \$current_version â†’ \$new_version"
          update_changelog_on_bump = true
          annotated_tag = true
          EOF
            echo "ðŸ“ Created .cz.toml config"
          fi
      
      - name: ðŸ·ï¸ Check existing tags
        run: |
          echo "Checking existing tags..."
          git tag -l | head -10
          
          # Se nÃ£o hÃ¡ tags, criar uma tag inicial
          if [ -z "$(git tag -l)" ]; then
            echo "No tags found, creating initial tag..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag v1.0.0
            echo "âœ… Created initial tag v1.0.0"
          else
            echo "âœ… Found existing tags"
            git describe --tags --abbrev=0
          fi
      
      - name: ðŸ“¦ Install Commitizen
        run: |
          pip install --upgrade pip
          pip install commitizen
      
      - name: ðŸ” Dry Run (if requested)
        if: ${{ inputs.dry_run }}
        run: |
          echo "ðŸ” Performing dry run..."
          if [ "${{ inputs.increment }}" = "auto" ]; then
            cz bump --dry-run --changelog
          else
            cz bump --increment ${{ inputs.increment }} --dry-run --changelog
          fi
      
      - name: ðŸš€ Create bump and changelog
        if: ${{ !inputs.dry_run }}
        run: |
          # Configurar git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "ðŸš€ Creating version bump..."
          if [ "${{ inputs.increment }}" = "auto" ]; then
            cz bump --yes --changelog
          else
            cz bump --increment ${{ inputs.increment }} --yes --changelog
          fi
      
      - name: ðŸ“¤ Push changes
        if: ${{ !inputs.dry_run }}
        run: |
          echo "ðŸ“¤ Pushing changes and tags..."
          git push
          git push --tags
      
      - name: ðŸ“‹ Show results
        run: |
          echo "ðŸ“‹ Bump completed!"
          echo "Latest tag:"
          git describe --tags --abbrev=0
          echo ""
          echo "Recent commits:"
          git log --oneline -5