name: ðŸš€ Bump Version and Generate Changelog (Commitizen)

permissions:
  contents: write
  pull-requests: write

on: 
  workflow_dispatch:
    inputs:
      increment:
        description: 'Increment type (auto/major/minor/patch)'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto
        - major
        - minor
        - patch
      dry_run:
        description: 'Dry run (no changes will be made)'
        required: false
        default: false
        type: boolean

jobs:
  bump-version:
    runs-on: ubuntu-latest
    name: "ðŸš€ Bump version and create changelog with commitizen"
    steps:
      - name: ðŸ“¥ Check out
        uses: actions/checkout@v4
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          fetch-depth: 0
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ðŸ“‹ Check if config exists
        run: |
          echo "Checking for Commitizen configuration..."
          if [ -f "pyproject.toml" ] && grep -q "tool.commitizen" pyproject.toml; then
            echo "âœ… Found pyproject.toml with Commitizen config"
          elif [ -f ".cz.toml" ]; then
            echo "âœ… Found .cz.toml config"
          else
            echo "âš ï¸ No Commitizen config found, creating minimal setup..."
            cat > .cz.toml << EOF
          [tool.commitizen]
          name = "cz_conventional_commits"
          version = "0.3.0"
          tag_format = "v\$version"
          changelog_file = "Secret Management/infra-secrets/CHANGELOG.md"
          changelog_start_rev = "v0.3.0"
          bump_message = "bump: version \$current_version â†’ \$new_version"
          update_changelog_on_bump = true
          annotated_tag = true
          EOF
            echo "ðŸ“ Created .cz.toml config with version 0.3.0"
          fi
      
      - name: ðŸ·ï¸ Check existing tags
        run: |
          echo "Checking existing tags..."
          git tag -l | head -10
          
          # Verificar se hÃ¡ tags existentes
          EXISTING_TAGS=$(git tag -l | head -1)
          if [ -z "$EXISTING_TAGS" ]; then
            echo "No tags found, creating initial tag..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Criar tag inicial baseada na versÃ£o atual no config
            INITIAL_VERSION="v0.3.0"
            git tag -a $INITIAL_VERSION -m "chore: initial tag $INITIAL_VERSION"
            echo "âœ… Created initial tag $INITIAL_VERSION"
            
            # Fazer push da tag inicial
            git push origin $INITIAL_VERSION
            echo "âœ… Pushed initial tag to remote"
          else
            echo "âœ… Found existing tags:"
            git tag -l | head -5
            echo "Latest tag: $(git describe --tags --abbrev=0)"
          fi
      
      - name: ðŸ“¦ Install Commitizen
        run: |
          pip install --upgrade pip
          pip install commitizen
      
      - name: ðŸ” Dry Run (if requested)
        if: ${{ inputs.dry_run }}
        run: |
          echo "ðŸ” Performing dry run..."
          if [ "${{ inputs.increment }}" = "auto" ]; then
            cz bump --dry-run --changelog
          else
            cz bump --increment ${{ inputs.increment }} --dry-run --changelog
          fi
      
      - name: ðŸš€ Create bump and changelog
        if: ${{ !inputs.dry_run }}
        run: |
          # Configurar git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "ðŸš€ Creating version bump..."
          
          # Verificar se hÃ¡ tags antes do bump
          if [ -z "$(git tag -l)" ]; then
            echo "âŒ No tags found. This should not happen after tag creation step."
            exit 1
          fi
          
          echo "Current tags:"
          git tag -l | sort -V | tail -5
          
          # Tentar bump com --changelog apenas se hÃ¡ pelo menos uma tag
          if [ "${{ inputs.increment }}" = "auto" ]; then
            echo "Running: cz bump --yes --changelog"
            if ! cz bump --yes --changelog; then
              echo "âš ï¸ Changelog incremental failed, trying without changelog..."
              cz bump --yes
              echo "âœ… Version bump completed without changelog"
            fi
          else
            echo "Running: cz bump --increment ${{ inputs.increment }} --yes --changelog"
            if ! cz bump --increment ${{ inputs.increment }} --yes --changelog; then
              echo "âš ï¸ Changelog incremental failed, trying without changelog..."
              cz bump --increment ${{ inputs.increment }} --yes
              echo "âœ… Version bump completed without changelog"
            fi
          fi
      
      - name: ï¿½ Generate changelog manually (fallback)
        if: ${{ !inputs.dry_run }}
        run: |
          echo "ðŸ“‹ Attempting to generate changelog manually..."
          
          # Verificar se changelog foi criado no step anterior
          CHANGELOG_FILE="Secret Management/infra-secrets/CHANGELOG.md"
          
          if [ ! -f "$CHANGELOG_FILE" ] || [ ! -s "$CHANGELOG_FILE" ]; then
            echo "Creating changelog directory..."
            mkdir -p "Secret Management/infra-secrets"
            
            echo "Generating basic changelog..."
            cat > "$CHANGELOG_FILE" << 'EOF'
          # ðŸ“‹ Changelog - Azure Key Vault Terraform Module
          
          Todas as mudanÃ§as notÃ¡veis neste projeto serÃ£o documentadas neste arquivo.
          
          O formato Ã© baseado em [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          e este projeto adere ao [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
          
          ## [Unreleased]
          
          ### âœ¨ Features
          - Azure Key Vault Terraform module with email-to-principal-id conversion
          - Configurable timeouts for resilient operations
          - Comprehensive documentation and troubleshooting guides
          - Validation scripts for testing
          - GitHub Actions for automated changelog generation
          
          ### ðŸ“š Documentation  
          - Complete setup and usage documentation
          - Troubleshooting guide for common issues
          - Examples and best practices
          
          ### ðŸ› ï¸ Infrastructure
          - CI/CD workflows for automation
          - Commitizen integration for standardized commits
          
          ---
          
          ## ðŸ“ž Suporte
          
          ### ðŸ“§ Contato
          - **Issues:** Use GitHub Issues para bugs e feature requests
          - **DiscussÃµes:** GitHub Discussions para dÃºvidas gerais
          - **DocumentaÃ§Ã£o:** Consulte README.md e docs/ folder
          
          ### ðŸ” Links Ãšteis
          - [ðŸ“‹ Changelog Completo](https://github.com/toolbox-tech/embracon/blob/main/Secret%20Management/infra-secrets/CHANGELOG.md)
          - [ðŸ·ï¸ Releases](https://github.com/toolbox-tech/embracon/releases)
          - [ðŸ“Š Commits](https://github.com/toolbox-tech/embracon/commits)
          
          ---
          
          <p align="center">
            <strong>ðŸš€ Azure Key Vault Terraform Module</strong><br>
            <em>Infraestrutura como CÃ³digo com SeguranÃ§a e Flexibilidade</em>
          </p>
          EOF
            
            echo "âœ… Basic changelog created at $CHANGELOG_FILE"
            
            # Add changelog to git
            git add "$CHANGELOG_FILE"
            if ! git diff --cached --quiet; then
              git commit -m "docs: add initial changelog"
              echo "âœ… Changelog committed"
            fi
          else
            echo "âœ… Changelog already exists and is not empty"
          fi
      
      - name: ï¿½ðŸ“¤ Push changes
        if: ${{ !inputs.dry_run }}
        run: |
          echo "ðŸ“¤ Pushing changes and tags..."
          git push
          git push --tags
      
      - name: ðŸ“‹ Show results
        run: |
          echo "ðŸ“‹ Bump completed!"
          echo "Latest tag:"
          git describe --tags --abbrev=0
          echo ""
          echo "Recent commits:"
          git log --oneline -5