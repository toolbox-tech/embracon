# Keycloak no Kubernetes: Instala√ß√£o, Configura√ß√£o e Gerenciamento

<div align="center">
  <img src="../../../img/tbx.png" alt="Toolbox Logo" width="200"/>
  <br><br>
  <strong>Embracon Toolbox - DevOps & Cloud Solutions</strong>
</div>

Esta documenta√ß√£o abrange como instalar, configurar e gerenciar o **Keycloak** como provedor de identidade em clusters Kubernetes, incluindo integra√ß√£o com RBAC e gerenciamento centralizado de usu√°rios.

## üìã √çndice

- [üöÄ O que √© Keycloak](#-o-que-√©-keycloak)
- [üèóÔ∏è Instala√ß√£o no Kubernetes](#Ô∏è-instala√ß√£o-no-kubernetes)
- [üîê Configura√ß√£o Inicial](#-configura√ß√£o-inicial)
- [üë• Gerenciamento de Usu√°rios](#-gerenciamento-de-usu√°rios)
- [üîó Integra√ß√£o com Kubernetes RBAC](#-integra√ß√£o-com-kubernetes-rbac)
- [üõ°Ô∏è Configura√ß√µes de Seguran√ßa](#Ô∏è-configura√ß√µes-de-seguran√ßa)
- [üîß Troubleshooting](#-troubleshooting)

## üöÄ O que √© Keycloak

**Keycloak** √© uma solu√ß√£o open-source de gerenciamento de identidade e acesso que oferece:

### üîë **Principais Funcionalidades:**
- **Single Sign-On (SSO)** - Login √∫nico para m√∫ltiplas aplica√ß√µes
- **Identity Brokering** - Integra√ß√£o com provedores externos (LDAP, Active Directory, Google, etc.)
- **User Federation** - Sincroniza√ß√£o com sistemas existentes
- **Fine-grained Authorization** - Controle granular de permiss√µes
- **Standard Protocols** - Suporte a OpenID Connect, OAuth 2.0, SAML 2.0
- **Multi-tenancy** - M√∫ltiplos realms isolados

### üéØ **Casos de Uso no Kubernetes:**
- **Autentica√ß√£o centralizada** para cluster Kubernetes
- **SSO** para aplica√ß√µes no cluster
- **Integra√ß√£o RBAC** com grupos e roles
- **API Gateway** authentication
- **Microservices** security

## üèóÔ∏è Arquitetura da Solu√ß√£o Keycloak

```mermaid
graph TB
    subgraph "üë• Usu√°rios e Aplica√ß√µes"
        USER[üë§ Usu√°rio Final]
        KUBECTL[‚öôÔ∏è kubectl]
        APP[üì± Aplica√ß√µes]
        BROWSER[üåç Navegador]
    end

    subgraph "üåê Acesso Externo"
        INGRESS[üö™ Ingress Controller]
        LB[‚öñÔ∏è Load Balancer]
        TLS[üîí TLS Termination]
    end

    subgraph "‚òÅÔ∏è Kubernetes Cluster"
        subgraph "üîê Keycloak Namespace"
            KC_POD[üîë Keycloak Pod]
            KC_SVC[üîß Keycloak Service]
            KC_CONFIG[üìã ConfigMap]
            KC_SECRET[üîê Secrets]
        end

        subgraph "üíæ Database"
            POSTGRES[üêò PostgreSQL]
            PVC[üíø Persistent Volume]
        end

        subgraph "üéØ Kubernetes API"
            API_SERVER[üéØ API Server]
            OIDC_CONFIG[üîë OIDC Configuration]
        end

        subgraph "üõ°Ô∏è RBAC System"
            CLUSTER_ROLES[üëë ClusterRoles]
            ROLE_BINDINGS[üîó RoleBindings]
            SERVICE_ACCOUNTS[‚öôÔ∏è Service Accounts]
        end

        subgraph "üìÅ Application Namespaces"
            NS_PROD[üî¥ Production]
            NS_DEV[üü° Development]
            NS_TEST[üîµ Testing]
        end
    end

    subgraph "üîó External Identity"
        LDAP[üìã LDAP/AD]
        GOOGLE[üîç Google SSO]
        AZURE[‚òÅÔ∏è Azure AD]
        GITHUB[üêô GitHub]
    end

    subgraph "üìä Monitoramento"
        PROMETHEUS[üìä Prometheus]
        GRAFANA[üìà Grafana]
        LOGS[üìù Logs]
    end

    %% Fluxos de Acesso
    USER --> BROWSER
    BROWSER -->|HTTPS| INGRESS
    INGRESS --> TLS
    TLS --> LB
    LB --> KC_SVC
    KC_SVC --> KC_POD

    %% Configura√ß√£o
    KC_POD --> KC_CONFIG
    KC_POD --> KC_SECRET
    KC_POD -->|Database Connection| POSTGRES
    POSTGRES --> PVC

    %% Integra√ß√£o Kubernetes
    KC_POD -->|OIDC Provider| API_SERVER
    API_SERVER --> OIDC_CONFIG
    OIDC_CONFIG --> CLUSTER_ROLES
    CLUSTER_ROLES --> ROLE_BINDINGS
    ROLE_BINDINGS --> SERVICE_ACCOUNTS

    %% Autentica√ß√£o kubectl
    KUBECTL -->|Login| KC_POD
    KC_POD -->|OIDC Token| KUBECTL
    KUBECTL -->|Bearer Token| API_SERVER

    %% Aplica√ß√µes
    APP -->|SSO Login| KC_POD
    KC_POD -->|JWT Token| APP
    APP --> NS_PROD
    APP --> NS_DEV
    APP --> NS_TEST

    %% Identity Federation
    KC_POD -->|User Federation| LDAP
    KC_POD -->|Social Login| GOOGLE
    KC_POD -->|Enterprise SSO| AZURE
    KC_POD -->|Developer Login| GITHUB

    %% Monitoramento
    KC_POD -->|Metrics| PROMETHEUS
    KC_POD -->|Logs| LOGS
    PROMETHEUS --> GRAFANA

    %% Estilos
    classDef userStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef accessStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef keycloakStyle fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef k8sStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef identityStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef monitoringStyle fill:#e0f2f1,stroke:#00796b,stroke-width:2px

    class USER,KUBECTL,APP,BROWSER userStyle
    class INGRESS,LB,TLS accessStyle
    class KC_POD,KC_SVC,KC_CONFIG,KC_SECRET,POSTGRES,PVC keycloakStyle
    class API_SERVER,OIDC_CONFIG,CLUSTER_ROLES,ROLE_BINDINGS,SERVICE_ACCOUNTS,NS_PROD,NS_DEV,NS_TEST k8sStyle
    class LDAP,GOOGLE,AZURE,GITHUB identityStyle
    class PROMETHEUS,GRAFANA,LOGS monitoringStyle
```

### üîç Componentes da Arquitetura

#### **üîê Camada de Identidade**
- **Keycloak Server**: Core do sistema de autentica√ß√£o
- **PostgreSQL**: Armazenamento persistente de dados
- **Realms**: Isolamento multi-tenant

#### **üåê Camada de Integra√ß√£o**
- **OIDC Provider**: Integra√ß√£o com Kubernetes API
- **Identity Federation**: Conex√£o com sistemas externos
- **Token Management**: JWT e refresh tokens

#### **üõ°Ô∏è Camada de Autoriza√ß√£o**
- **RBAC Integration**: Mapeamento grupos ‚Üí roles
- **Service Accounts**: Contas para aplica√ß√µes
- **Namespace Isolation**: Controle granular por ambiente

#### **üìä Camada de Observabilidade**
- **Metrics**: Prometheus integration
- **Logging**: Centralized log management
- **Monitoring**: Health checks e alertas

## üèóÔ∏è Instala√ß√£o no Kubernetes

### M√©todo 1: Helm Chart (Recomendado)

```bash
# Adicionar reposit√≥rio do Keycloak
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

# Criar namespace
kubectl create namespace keycloak

# Instalar Keycloak
helm install keycloak bitnami/keycloak \
  --namespace keycloak \
  --set auth.adminUser=admin \
  --set auth.adminPassword=admin123 \
  --set postgresql.auth.postgresPassword=postgres123 \
  --set service.type=ClusterIP \
  --set ingress.enabled=true \
  --set ingress.hostname=keycloak.local
```

### M√©todo 2: Operator (Produ√ß√£o)

```bash
# Instalar Keycloak Operator
kubectl apply -f https://raw.githubusercontent.com/keycloak/keycloak-k8s-resources/main/kubernetes/keycloaks.k8s.keycloak.org-v1.yml
kubectl apply -f https://raw.githubusercontent.com/keycloak/keycloak-k8s-resources/main/kubernetes/keycloakrealmimports.k8s.keycloak.org-v1.yml

# Criar namespace
kubectl create namespace keycloak

# Deploy Keycloak via Operator
cat <<EOF | kubectl apply -f -
apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  name: keycloak
  namespace: keycloak
spec:
  instances: 1
  db:
    vendor: postgres
    host: postgres-service
    usernameSecret:
      name: keycloak-db-secret
      key: username
    passwordSecret:
      name: keycloak-db-secret
      key: password
  http:
    tlsSecret: keycloak-tls-secret
  hostname:
    hostname: keycloak.example.com
  ingress:
    enabled: true
EOF
```

### M√©todo 3: Manifests Personalizados

```yaml
# keycloak-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: keycloak
  labels:
    app: keycloak
spec:
  replicas: 1
  selector:
    matchLabels:
      app: keycloak
  template:
    metadata:
      labels:
        app: keycloak
    spec:
      containers:
      - name: keycloak
        image: quay.io/keycloak/keycloak:23.0.3
        args: ["start-dev"]
        env:
        - name: KEYCLOAK_ADMIN
          value: "admin"
        - name: KEYCLOAK_ADMIN_PASSWORD
          value: "admin123"
        - name: KC_PROXY
          value: "edge"
        ports:
        - name: http
          containerPort: 8080
        readinessProbe:
          httpGet:
            path: /realms/master
            port: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: keycloak
  namespace: keycloak
spec:
  selector:
    app: keycloak
  ports:
  - name: http
    port: 8080
    targetPort: 8080
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: keycloak
  namespace: keycloak
  annotations:
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
spec:
  rules:
  - host: keycloak.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: keycloak
            port:
              number: 8080
```

### Verificar Instala√ß√£o

```bash
# Verificar pods
kubectl get pods -n keycloak

# Verificar servi√ßos
kubectl get svc -n keycloak

# Verificar ingress
kubectl get ingress -n keycloak

# Logs do Keycloak
kubectl logs -n keycloak deployment/keycloak
```

## üîê Configura√ß√£o Inicial

### 1. Acesso ao Admin Console

```bash
# Port-forward para acesso local
kubectl port-forward -n keycloak svc/keycloak 8080:8080

# Acessar: http://localhost:8080
# Login: admin / admin123
```

### 2. Criar Realm para Kubernetes

```bash
# Via Admin Console:
# 1. Master realm -> Dropdown -> Add Realm
# 2. Name: "kubernetes"
# 3. Enabled: ON
# 4. Create
```

### 3. Configurar Client para Kubernetes

```json
{
  "clientId": "kubernetes",
  "name": "Kubernetes Cluster",
  "protocol": "openid-connect",
  "clientAuthenticatorType": "client-secret",
  "secret": "kubernetes-client-secret",
  "redirectUris": [
    "http://localhost:8000",
    "https://kubernetes-dashboard.local/*"
  ],
  "webOrigins": [
    "https://kubernetes-dashboard.local"
  ],
  "publicClient": false,
  "bearerOnly": false,
  "consentRequired": false,
  "standardFlowEnabled": true,
  "implicitFlowEnabled": false,
  "directAccessGrantsEnabled": true,
  "serviceAccountsEnabled": false,
  "frontchannelLogout": true,
  "fullScopeAllowed": true,
  "attributes": {
    "saml.assertion.signature": "false",
    "saml.force.post.binding": "false",
    "saml.multivalued.roles": "false",
    "saml.encrypt": "false",
    "saml_force_name_id_format": "false",
    "saml.client.signature": "false",
    "tls.client.certificate.bound.access.tokens": "false",
    "saml.authnstatement": "false",
    "display.on.consent.screen": "false",
    "saml.onetimeuse.condition": "false"
  }
}
```

### 4. Configurar Mappers

```bash
# Criar Group Mapper
# Client -> kubernetes -> Mappers -> Create
# Name: "groups"
# Mapper Type: "Group Membership"
# Token Claim Name: "groups"
# Full group path: OFF
# Add to ID token: ON
# Add to access token: ON
```

## üë• Gerenciamento de Usu√°rios

### 1. Criar Grupos

```bash
# Via Admin Console:
# Realm: kubernetes -> Groups -> New

# Criar grupos hier√°rquicos:
# - admins
#   - cluster-admins
#   - namespace-admins
# - developers
#   - dev-team
#   - qa-team
# - viewers
#   - read-only
```

### 2. Criar Usu√°rios

```json
{
  "username": "john.doe",
  "email": "john.doe@example.com",
  "firstName": "John",
  "lastName": "Doe",
  "enabled": true,
  "emailVerified": true,
  "credentials": [
    {
      "type": "password",
      "value": "password123",
      "temporary": false
    }
  ],
  "groups": [
    "/developers/dev-team"
  ],
  "attributes": {
    "department": ["engineering"],
    "location": ["sao-paulo"]
  }
}
```

### 3. Bulk Import via REST API

```bash
# Obter token admin
ADMIN_TOKEN=$(curl -s -X POST http://keycloak.local:8080/realms/master/protocol/openid-connect/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=admin-cli" \
  -d "username=admin" \
  -d "password=admin123" | jq -r '.access_token')

# Criar usu√°rio via API
curl -X POST http://keycloak.local:8080/admin/realms/kubernetes/users \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "api-user",
    "email": "api-user@example.com",
    "enabled": true,
    "credentials": [
      {
        "type": "password",
        "value": "password123",
        "temporary": false
      }
    ]
  }'
```

### 4. Configurar User Federation

#### LDAP Integration

```json
{
  "providerId": "ldap",
  "providerType": "org.keycloak.storage.UserStorageProvider",
  "name": "ldap-provider",
  "config": {
    "connectionUrl": ["ldap://ldap.example.com:389"],
    "usersDn": ["ou=users,dc=example,dc=com"],
    "bindDn": ["cn=admin,dc=example,dc=com"],
    "bindCredential": ["admin-password"],
    "userObjectClasses": ["inetOrgPerson, organizationalPerson"],
    "usernameLDAPAttribute": ["uid"],
    "rdnLDAPAttribute": ["uid"],
    "uuidLDAPAttribute": ["entryUUID"],
    "userLDAPFilter": [""],
    "searchScope": ["1"],
    "validatePasswordPolicy": ["false"],
    "trustEmail": ["false"],
    "useTruststoreSpi": ["ldapsOnly"],
    "connectionPooling": ["true"],
    "pagination": ["true"],
    "allowKerberosAuthentication": ["false"],
    "debug": ["false"],
    "useKerberosForPasswordAuthentication": ["false"]
  }
}
```

## üîó Integra√ß√£o com Kubernetes RBAC

### üîÑ Fluxo de Autentica√ß√£o OIDC com Keycloak

```mermaid
sequenceDiagram
    participant U as üë§ Usu√°rio
    participant K as ‚öôÔ∏è kubectl
    participant KC as üîë Keycloak
    participant API as üéØ API Server
    participant RBAC as üõ°Ô∏è RBAC Controller
    participant R as üì¶ Resources

    Note over U,R: üîê Configura√ß√£o Inicial OIDC
    
    API->>API: Configure OIDC<br/>--oidc-issuer-url<br/>--oidc-client-id<br/>--oidc-groups-claim
    KC->>KC: Create kubernetes realm<br/>Create kubernetes client<br/>Configure group mappings

    Note over U,R: üöÄ Fluxo de Login
    
    U->>+K: kubectl login
    K->>+KC: 1. OIDC Discovery<br/>GET /.well-known/openid_configuration
    KC->>K: 2. OIDC Endpoints
    
    K->>KC: 3. Authorization Request<br/>GET /auth?client_id=kubernetes
    KC->>U: 4. Login Page
    U->>KC: 5. Credentials
    KC->>+KC: 6. Authenticate User<br/>Validate against LDAP/DB
    KC->>KC: 7. Check Group Membership
    KC->>K: 8. Authorization Code
    
    K->>+KC: 9. Token Exchange<br/>POST /token
    KC->>K: 10. ID Token + Access Token<br/>JWT with groups claim
    K->>K: 11. Store tokens in kubeconfig

    Note over U,R: üõ°Ô∏è Fluxo de Autoriza√ß√£o
    
    U->>K: kubectl get pods
    K->>+API: 12. API Request<br/>Bearer: JWT Token
    API->>+KC: 13. Token Validation<br/>Verify JWT signature
    KC->>API: 14. Token Valid + Claims
    
    API->>API: 15. Extract username<br/>Extract groups from JWT
    API->>+RBAC: 16. Authorization Check<br/>User: john.doe<br/>Groups: [developers, dev-team]
    
    RBAC->>RBAC: 17. Find matching<br/>ClusterRoleBindings<br/>RoleBindings
    RBAC->>RBAC: 18. Check permissions<br/>GET pods in namespace
    RBAC->>API: 19. Allow/Deny decision
    
    alt Authorization Success
        API->>+R: 20. Fetch resources
        R->>API: 21. Resource data
        API->>K: 22. Response: Pod list
        K->>U: 23. Display pods
    else Authorization Failure
        API->>K: 24. 403 Forbidden
        K->>U: 25. Access denied
    end

    Note over U,R: üîÑ Token Refresh (Background)
    
    K->>KC: Refresh token when expired
    KC->>K: New access token
```

### üîç Componentes do Fluxo OIDC

| Componente | Fun√ß√£o | Configura√ß√£o |
|-----------|--------|-------------|
| **üîë Keycloak** | Identity Provider | Realm, Client, Group Mappers |
| **üéØ API Server** | Resource Server | OIDC flags, CA certificates |
| **‚öôÔ∏è kubectl** | OIDC Client | kubeconfig com OIDC provider |
| **üõ°Ô∏è RBAC** | Authorization | ClusterRoles, RoleBindings |
| **üé´ JWT Token** | Identity Proof | Username + Groups claims |

### 1. Configurar OIDC no API Server

```yaml
# /etc/kubernetes/manifests/kube-apiserver.yaml
apiVersion: v1
kind: Pod
metadata:
  name: kube-apiserver
spec:
  containers:
  - command:
    - kube-apiserver
    - --oidc-issuer-url=http://keycloak.local:8080/realms/kubernetes
    - --oidc-client-id=kubernetes
    - --oidc-username-claim=preferred_username
    - --oidc-groups-claim=groups
    - --oidc-ca-file=/etc/ssl/certs/ca-certificates.crt
```

### 2. Criar RBAC Bindings

```yaml
# cluster-admin-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: keycloak-cluster-admins
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: Group
  name: /admins/cluster-admins
  apiGroup: rbac.authorization.k8s.io
---
# namespace-admin-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keycloak-namespace-admins
  namespace: development
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: admin
subjects:
- kind: Group
  name: /admins/namespace-admins
  apiGroup: rbac.authorization.k8s.io
---
# developers-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: developer-role
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps", "secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keycloak-developers
  namespace: development
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: developer-role
subjects:
- kind: Group
  name: /developers
  apiGroup: rbac.authorization.k8s.io
```

### üèóÔ∏è Estrutura de Grupos e Mapeamento RBAC

```mermaid
graph TB
    subgraph "üîë Keycloak Groups (Hierarchical)"
        ROOT[üìÅ Root Groups]
        
        subgraph "üëë Administrators"
            ADMIN_ROOT[üëë /admins]
            CLUSTER_ADMIN[üåê /admins/cluster-admins]
            NS_ADMIN[üìÅ /admins/namespace-admins]
            SECURITY_ADMIN[üõ°Ô∏è /admins/security-admins]
        end

        subgraph "üë®‚Äçüíª Developers"
            DEV_ROOT[üë®‚Äçüíª /developers]
            SENIOR_DEV[‚≠ê /developers/senior-devs]
            JUNIOR_DEV[üå± /developers/junior-devs]
            QA_TEAM[üß™ /developers/qa-team]
            DEVOPS_TEAM[üöÄ /developers/devops-team]
        end

        subgraph "üëÄ Viewers"
            VIEWER_ROOT[üëÄ /viewers]
            READ_ONLY[üìñ /viewers/read-only]
            MONITORING[üìä /viewers/monitoring]
            AUDIT[üìã /viewers/audit]
        end

        ROOT --> ADMIN_ROOT
        ROOT --> DEV_ROOT
        ROOT --> VIEWER_ROOT
        
        ADMIN_ROOT --> CLUSTER_ADMIN
        ADMIN_ROOT --> NS_ADMIN
        ADMIN_ROOT --> SECURITY_ADMIN
        
        DEV_ROOT --> SENIOR_DEV
        DEV_ROOT --> JUNIOR_DEV
        DEV_ROOT --> QA_TEAM
        DEV_ROOT --> DEVOPS_TEAM
        
        VIEWER_ROOT --> READ_ONLY
        VIEWER_ROOT --> MONITORING
        VIEWER_ROOT --> AUDIT
    end

    subgraph "üõ°Ô∏è Kubernetes RBAC"
        subgraph "üåê Cluster-Level Roles"
            CR_ADMIN[üëë cluster-admin]
            CR_VIEW[üëÄ view]
            CR_EDIT[‚úèÔ∏è edit]
            CR_CUSTOM[üîß custom-developer-role]
            CR_SECURITY[üõ°Ô∏è security-role]
        end

        subgraph "üîó Cluster Bindings"
            CRB_ADMIN[üîó cluster-admin-binding]
            CRB_DEV[üîó developers-binding]
            CRB_VIEW[üîó viewers-binding]
            CRB_SECURITY[üîó security-binding]
        end

        subgraph "üìÅ Namespace-Level"
            subgraph "üî¥ Production Namespace"
                R_PROD_ADMIN[üëë prod-admin-role]
                RB_PROD_ADMIN[üîó prod-admin-binding]
                R_PROD_DEPLOY[üöÄ prod-deployer-role]
                RB_PROD_DEPLOY[üîó prod-deployer-binding]
            end

            subgraph "üü° Development Namespace"
                R_DEV_FULL[üë®‚Äçüíª dev-full-access]
                RB_DEV_FULL[üîó dev-full-binding]
                R_DEV_READONLY[üìñ dev-readonly]
                RB_DEV_READONLY[üîó dev-readonly-binding]
            end

            subgraph "üîµ Testing Namespace"
                R_TEST_QA[üß™ qa-role]
                RB_TEST_QA[üîó qa-binding]
                R_TEST_VIEW[üëÄ test-viewer]
                RB_TEST_VIEW[üîó test-viewer-binding]
            end
        end
    end

    %% Mapeamento Cluster-Level
    CLUSTER_ADMIN --> CRB_ADMIN
    CRB_ADMIN --> CR_ADMIN

    SENIOR_DEV --> CRB_DEV
    DEVOPS_TEAM --> CRB_DEV
    CRB_DEV --> CR_CUSTOM

    READ_ONLY --> CRB_VIEW
    MONITORING --> CRB_VIEW
    CRB_VIEW --> CR_VIEW

    SECURITY_ADMIN --> CRB_SECURITY
    CRB_SECURITY --> CR_SECURITY

    %% Mapeamento Production Namespace
    NS_ADMIN --> RB_PROD_ADMIN
    RB_PROD_ADMIN --> R_PROD_ADMIN
    
    DEVOPS_TEAM --> RB_PROD_DEPLOY
    RB_PROD_DEPLOY --> R_PROD_DEPLOY

    %% Mapeamento Development Namespace
    SENIOR_DEV --> RB_DEV_FULL
    JUNIOR_DEV --> RB_DEV_FULL
    RB_DEV_FULL --> R_DEV_FULL

    AUDIT --> RB_DEV_READONLY
    RB_DEV_READONLY --> R_DEV_READONLY

    %% Mapeamento Testing Namespace
    QA_TEAM --> RB_TEST_QA
    RB_TEST_QA --> R_TEST_QA

    MONITORING --> RB_TEST_VIEW
    RB_TEST_VIEW --> R_TEST_VIEW

    %% Estilos
    classDef keycloakStyle fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef adminStyle fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef devStyle fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef viewerStyle fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef k8sStyle fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef namespaceStyle fill:#e0f2f1,stroke:#00695c,stroke-width:2px

    class ROOT,ADMIN_ROOT,DEV_ROOT,VIEWER_ROOT keycloakStyle
    class CLUSTER_ADMIN,NS_ADMIN,SECURITY_ADMIN,CR_ADMIN,CRB_ADMIN,CR_SECURITY,CRB_SECURITY adminStyle
    class SENIOR_DEV,JUNIOR_DEV,QA_TEAM,DEVOPS_TEAM,CR_EDIT,CR_CUSTOM,CRB_DEV devStyle
    class READ_ONLY,MONITORING,AUDIT,CR_VIEW,CRB_VIEW viewerStyle
    class R_PROD_ADMIN,RB_PROD_ADMIN,R_DEV_FULL,RB_DEV_FULL,R_TEST_QA,RB_TEST_QA k8sStyle
    class R_PROD_DEPLOY,RB_PROD_DEPLOY,R_DEV_READONLY,RB_DEV_READONLY,R_TEST_VIEW,RB_TEST_VIEW namespaceStyle
```

### üìä Matriz de Permiss√µes por Grupo

| Keycloak Group | Kubernetes Role | Scope | Permiss√µes | Recursos |
|----------------|----------------|--------|------------|----------|
| üåê `/admins/cluster-admins` | cluster-admin | Cluster | Todas | Todos os recursos |
| üìÅ `/admins/namespace-admins` | admin | Namespace espec√≠fico | Gerenciar namespace | Todos exceto RBAC |
| üõ°Ô∏è `/admins/security-admins` | security-role | Cluster | Auditoria + RBAC | Secrets, RBAC, Policies |
| ‚≠ê `/developers/senior-devs` | developer-role | Multi-namespace | Deploy + Debug | Pods, Services, Deployments |
| üå± `/developers/junior-devs` | developer-role | Development | Desenvolvimento | Pods, ConfigMaps, Logs |
| üß™ `/developers/qa-team` | qa-role | Testing | Teste + Valida√ß√£o | Pods, Services, Jobs |
| üöÄ `/developers/devops-team` | deployer-role | Production | Deploy produ√ß√£o | Deployments, Services |
| üìñ `/viewers/read-only` | view | Cluster | Apenas leitura | Visualiza√ß√£o de recursos |
| üìä `/viewers/monitoring` | monitoring-role | Cluster | M√©tricas + Logs | Metrics, Logs, Events |
| üìã `/viewers/audit` | audit-role | Cluster | Auditoria | Logs, Events, RBAC |

### 3. Configurar kubectl para OIDC

```bash
# Instalar oidc-login plugin
kubectl krew install oidc-login

# Configurar kubeconfig
kubectl config set-credentials oidc \
  --exec-api-version=client.authentication.k8s.io/v1beta1 \
  --exec-command=kubectl \
  --exec-arg=oidc-login \
  --exec-arg=get-token \
  --exec-arg=--oidc-issuer-url=http://keycloak.local:8080/realms/kubernetes \
  --exec-arg=--oidc-client-id=kubernetes \
  --exec-arg=--oidc-client-secret=kubernetes-client-secret

# Usar contexto OIDC
kubectl config set-context oidc \
  --cluster=kubernetes \
  --user=oidc

kubectl config use-context oidc
```

## üõ°Ô∏è Configura√ß√µes de Seguran√ßa

### üîê Arquitetura de Seguran√ßa e Monitoramento

```mermaid
graph TB
    subgraph "üåç External Access"
        INTERNET[üåê Internet]
        CDN[‚ö° CDN/WAF]
        LB[‚öñÔ∏è Load Balancer]
    end

    subgraph "üõ°Ô∏è Security Perimeter"
        FIREWALL[üî• Firewall]
        VPN[üîí VPN Gateway]
        BASTION[üè∞ Bastion Host]
    end

    subgraph "‚òÅÔ∏è Kubernetes Cluster Security"
        subgraph "üö™ Ingress Security"
            INGRESS[üåê Ingress Controller]
            TLS_TERM[üîí TLS Termination]
            RATE_LIMIT[‚è±Ô∏è Rate Limiting]
            WAF_RULES[üõ°Ô∏è WAF Rules]
        end

        subgraph "üîë Keycloak Security"
            KC_POD[üîë Keycloak Pod]
            KC_CONFIG[üìã Security Config]
            KC_SECRETS[üîê Secrets Management]
            KC_TLS[üîí Internal TLS]
            
            subgraph "üõ°Ô∏è Keycloak Security Features"
                MFA[üî¢ Multi-Factor Auth]
                BRUTE_FORCE[üö´ Brute Force Protection]
                PASSWORD_POLICY[üîë Password Policies]
                SESSION_MGT[‚è∞ Session Management]
                AUDIT_LOG[üìù Audit Logging]
            end
        end

        subgraph "üíæ Database Security"
            POSTGRES[üêò PostgreSQL]
            DB_ENCRYPTION[üîê Data Encryption]
            DB_BACKUP[üíø Encrypted Backups]
            DB_SECRETS[üîë DB Credentials]
        end

        subgraph "üéØ API Server Security"
            API_SERVER[üéØ Kubernetes API]
            OIDC_VALIDATION[‚úÖ OIDC Token Validation]
            RBAC_ENGINE[üõ°Ô∏è RBAC Engine]
            ADMISSION_CTRL[üö¶ Admission Controllers]
        end

        subgraph "üìä Monitoring & Alerting"
            PROMETHEUS[üìä Prometheus]
            GRAFANA[üìà Grafana]
            ALERTMANAGER[üö® AlertManager]
            LOG_AGGREGATOR[üìù Log Aggregation]
            SIEM[üîç SIEM Integration]
        end

        subgraph "üîí Secret Management"
            VAULT[üîê HashiCorp Vault]
            SEALED_SECRETS[üì¶ Sealed Secrets]
            EXTERNAL_SECRETS[üîó External Secrets]
        end

        subgraph "üåê Network Security"
            NETWORK_POLICIES[üöß Network Policies]
            SERVICE_MESH[üï∏Ô∏è Service Mesh]
            MTLS[üîí mTLS]
        end
    end

    subgraph "üîç Security Monitoring"
        SECURITY_DASHBOARD[üìä Security Dashboard]
        COMPLIANCE_REPORTS[üìã Compliance Reports]
        THREAT_DETECTION[‚ö†Ô∏è Threat Detection]
        INCIDENT_RESPONSE[üö® Incident Response]
    end

    %% External Access Flow
    INTERNET --> CDN
    CDN --> LB
    LB --> FIREWALL
    FIREWALL --> VPN
    VPN --> BASTION

    %% Ingress Security
    BASTION --> INGRESS
    INGRESS --> TLS_TERM
    TLS_TERM --> RATE_LIMIT
    RATE_LIMIT --> WAF_RULES

    %% Keycloak Security Flow
    WAF_RULES --> KC_POD
    KC_POD --> KC_CONFIG
    KC_POD --> KC_SECRETS
    KC_POD --> KC_TLS

    KC_POD --> MFA
    KC_POD --> BRUTE_FORCE
    KC_POD --> PASSWORD_POLICY
    KC_POD --> SESSION_MGT
    KC_POD --> AUDIT_LOG

    %% Database Security
    KC_POD --> POSTGRES
    POSTGRES --> DB_ENCRYPTION
    POSTGRES --> DB_BACKUP
    DB_SECRETS --> POSTGRES

    %% API Security
    KC_POD --> API_SERVER
    API_SERVER --> OIDC_VALIDATION
    API_SERVER --> RBAC_ENGINE
    API_SERVER --> ADMISSION_CTRL

    %% Secret Management
    KC_SECRETS --> VAULT
    DB_SECRETS --> SEALED_SECRETS
    VAULT --> EXTERNAL_SECRETS

    %% Network Security
    KC_POD --> NETWORK_POLICIES
    NETWORK_POLICIES --> SERVICE_MESH
    SERVICE_MESH --> MTLS

    %% Monitoring Flow
    KC_POD --> PROMETHEUS
    POSTGRES --> PROMETHEUS
    API_SERVER --> PROMETHEUS
    PROMETHEUS --> GRAFANA
    PROMETHEUS --> ALERTMANAGER
    AUDIT_LOG --> LOG_AGGREGATOR
    LOG_AGGREGATOR --> SIEM

    %% Security Analytics
    PROMETHEUS --> SECURITY_DASHBOARD
    GRAFANA --> SECURITY_DASHBOARD
    SIEM --> COMPLIANCE_REPORTS
    SIEM --> THREAT_DETECTION
    THREAT_DETECTION --> INCIDENT_RESPONSE

    %% Estilos
    classDef externalStyle fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef perimeterStyle fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef ingressStyle fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef keycloakStyle fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef dbStyle fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef k8sStyle fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    classDef monitoringStyle fill:#fce4ec,stroke:#ad1457,stroke-width:2px
    classDef secretStyle fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef networkStyle fill:#f9fbe7,stroke:#689f38,stroke-width:2px
    classDef securityStyle fill:#fff8e1,stroke:#f57f17,stroke-width:2px

    class INTERNET,CDN,LB externalStyle
    class FIREWALL,VPN,BASTION perimeterStyle
    class INGRESS,TLS_TERM,RATE_LIMIT,WAF_RULES ingressStyle
    class KC_POD,KC_CONFIG,KC_SECRETS,KC_TLS,MFA,BRUTE_FORCE,PASSWORD_POLICY,SESSION_MGT,AUDIT_LOG keycloakStyle
    class POSTGRES,DB_ENCRYPTION,DB_BACKUP,DB_SECRETS dbStyle
    class API_SERVER,OIDC_VALIDATION,RBAC_ENGINE,ADMISSION_CTRL k8sStyle
    class PROMETHEUS,GRAFANA,ALERTMANAGER,LOG_AGGREGATOR,SIEM monitoringStyle
    class VAULT,SEALED_SECRETS,EXTERNAL_SECRETS secretStyle
    class NETWORK_POLICIES,SERVICE_MESH,MTLS networkStyle
    class SECURITY_DASHBOARD,COMPLIANCE_REPORTS,THREAT_DETECTION,INCIDENT_RESPONSE securityStyle
```

### üõ°Ô∏è Camadas de Seguran√ßa

| Camada | Componente | Prote√ß√£o | Configura√ß√£o |
|---------|------------|----------|-------------|
| **üåê Perimeter** | Firewall + WAF | DDoS, SQL Injection | Rate limiting, Geo-blocking |
| **üö™ Ingress** | TLS + Authentication | MITM, Unauthorized access | Certificates, OIDC |
| **üîë Identity** | Keycloak | Authentication, MFA | Password policies, Brute force protection |
| **üéØ Authorization** | Kubernetes RBAC | Privilege escalation | Least privilege, Group mapping |
| **üíæ Data** | Encryption | Data breach | At-rest + in-transit encryption |
| **üåê Network** | Network Policies | Lateral movement | Zero-trust networking |
| **üìä Monitoring** | Logs + Metrics | Security events | Real-time alerting, SIEM |

### üö® Security Checklist

#### **üîê Keycloak Security**
- ‚úÖ HTTPS obrigat√≥rio (TLS 1.2+)
- ‚úÖ Pol√≠ticas de senha robustas
- ‚úÖ Multi-Factor Authentication habilitado
- ‚úÖ Prote√ß√£o contra brute force ativada
- ‚úÖ Sess√µes com timeout configurado
- ‚úÖ Logs de auditoria habilitados
- ‚úÖ Backup do banco criptografado

#### **‚òÅÔ∏è Kubernetes Security**
- ‚úÖ RBAC configurado com princ√≠pio do menor privil√©gio
- ‚úÖ Network Policies implementadas
- ‚úÖ Pod Security Standards aplicadas
- ‚úÖ Secrets criptografadas no etcd
- ‚úÖ Admission Controllers configurados
- ‚úÖ Regular security scans

#### **üìä Monitoring Security**
- ‚úÖ M√©tricas de seguran√ßa coletadas
- ‚úÖ Alertas para eventos suspeitos
- ‚úÖ Logs centralizados e protegidos
- ‚úÖ Dashboards de seguran√ßa configurados
- ‚úÖ Integra√ß√£o com SIEM
- ‚úÖ Incident response procedures

### 1. Configurar TLS

```yaml
# keycloak-tls-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-tls-secret
  namespace: keycloak
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTi...  # Base64 encoded certificate
  tls.key: LS0tLS1CRUdJTi...  # Base64 encoded private key
```

### 2. Configurar Pol√≠ticas de Senha

```json
{
  "passwordPolicy": "length(8) and digits(1) and lowerCase(1) and upperCase(1) and specialChars(1) and notUsername",
  "attributes": {
    "bruteForceProtected": "true",
    "maxFailureWaitSeconds": "900",
    "minimumQuickLoginWaitSeconds": "60",
    "waitIncrementSeconds": "60",
    "quickLoginCheckMilliSeconds": "1000",
    "maxDeltaTimeSeconds": "43200",
    "failureFactor": "30"
  }
}
```

### 3. Configurar Autentica√ß√£o Multi-Fator

```bash
# Habilitar OTP
# Realm Settings -> Authentication -> Flows -> Browser
# Add OTP Form execution
# Set to REQUIRED
```

### 4. Configurar Auditoria

```json
{
  "eventsEnabled": true,
  "eventsExpiration": 604800,
  "eventsListeners": ["jboss-logging"],
  "enabledEventTypes": [
    "LOGIN",
    "LOGIN_ERROR",
    "LOGOUT",
    "USER_INFO_REQUEST",
    "PERMISSION_TOKEN",
    "CODE_TO_TOKEN",
    "REFRESH_TOKEN"
  ],
  "adminEventsEnabled": true,
  "adminEventsDetailsEnabled": true
}
```

## üîß Troubleshooting

### 1. Keycloak n√£o inicia

```bash
# Verificar logs
kubectl logs -n keycloak deployment/keycloak

# Problemas comuns:
# - Banco de dados n√£o acess√≠vel
# - Configura√ß√£o de proxy incorreta
# - Recursos insuficientes

# Verificar recursos
kubectl describe pod -n keycloak -l app=keycloak
```

### 2. Autentica√ß√£o OIDC falha

```bash
# Verificar configura√ß√£o do API server
kubectl describe pod -n kube-system kube-apiserver

# Testar conectividade do Keycloak
curl -k http://keycloak.local:8080/realms/kubernetes/.well-known/openid_configuration

# Verificar certificados
openssl s_client -connect keycloak.local:443 -showcerts
```

### 3. Usu√°rios n√£o conseguem autenticar

```bash
# Verificar grupos no token
# Admin Console -> Realm Settings -> Keys -> RS256 -> Certificate
# Usar jwt.io para decodificar token

# Verificar RBAC bindings
kubectl get clusterrolebinding,rolebinding --all-namespaces | grep keycloak

# Testar permiss√µes
kubectl auth can-i get pods --as=system:user:john.doe --as-group=/developers/dev-team
```

### 4. Performance Issues

```bash
# Verificar m√©tricas
kubectl top pod -n keycloak

# Configurar recursos adequados
kubectl patch deployment keycloak -n keycloak -p '{
  "spec": {
    "template": {
      "spec": {
        "containers": [
          {
            "name": "keycloak",
            "resources": {
              "requests": {"memory": "1Gi", "cpu": "500m"},
              "limits": {"memory": "2Gi", "cpu": "1000m"}
            }
          }
        ]
      }
    }
  }
}'
```

### 5. Backup e Restore

```bash
# Backup do banco de dados
kubectl exec -n keycloak deployment/postgres -- pg_dump -U keycloak keycloak > keycloak-backup.sql

# Export de realm
curl -X GET "http://keycloak.local:8080/admin/realms/kubernetes" \
  -H "Authorization: Bearer $ADMIN_TOKEN" > kubernetes-realm-export.json

# Import de realm
curl -X POST "http://keycloak.local:8080/admin/realms" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d @kubernetes-realm-export.json
```

## üìä Monitoramento e M√©tricas

### 1. Configurar Prometheus Metrics

```yaml
# keycloak-servicemonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: keycloak
  namespace: keycloak
spec:
  selector:
    matchLabels:
      app: keycloak
  endpoints:
  - port: http
    path: /metrics
```

### 2. Dashboard Grafana

```json
{
  "dashboard": {
    "title": "Keycloak Metrics",
    "panels": [
      {
        "title": "Active Sessions",
        "type": "stat",
        "targets": [
          {
            "expr": "keycloak_user_sessions_total"
          }
        ]
      },
      {
        "title": "Login Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(keycloak_logins_total[5m])"
          }
        ]
      }
    ]
  }
}
```

## üß™ Testes e Valida√ß√£o

### üåê Topologia de Rede e Conectividade

```mermaid
graph TB
    subgraph "üåç Internet Zone"
        USER[üë§ End User]
        ADMIN[üë®‚Äçüíº Administrator]
        DEVELOPER[üë®‚Äçüíª Developer]
    end

    subgraph "üõ°Ô∏è DMZ (Perimeter Network)"
        LB[‚öñÔ∏è Load Balancer<br/>Public IP]
        WAF[üõ°Ô∏è Web Application Firewall<br/>Security Rules]
        VPN_GW[üîí VPN Gateway<br/>Admin Access]
    end

    subgraph "‚òÅÔ∏è Kubernetes Cluster Network"
        subgraph "üö™ Ingress Tier (10.0.1.0/24)"
            NGINX_INGRESS[üåê NGINX Ingress<br/>443/tcp, 80/tcp]
            CERT_MANAGER[üìú Cert Manager<br/>Let's Encrypt]
        end

        subgraph "üîë Identity Tier (10.0.2.0/24)"
            KC_SVC[üîë Keycloak Service<br/>ClusterIP: 8080]
            KC_POD_1[üîë Keycloak Pod 1<br/>10.0.2.10:8080]
            KC_POD_2[üîë Keycloak Pod 2<br/>10.0.2.11:8080]
            KC_POD_3[üîë Keycloak Pod 3<br/>10.0.2.12:8080]
        end

        subgraph "üíæ Data Tier (10.0.3.0/24)"
            POSTGRES_SVC[üêò PostgreSQL Service<br/>ClusterIP: 5432]
            POSTGRES_MASTER[üêò PostgreSQL Master<br/>10.0.3.10:5432]
            POSTGRES_REPLICA[üêò PostgreSQL Replica<br/>10.0.3.11:5432]
            PVC_STORAGE[üíæ Persistent Storage<br/>Encrypted]
        end

        subgraph "üéØ Control Plane (10.0.0.0/24)"
            API_SERVER[üéØ Kubernetes API<br/>6443/tcp]
            ETCD[üóÑÔ∏è etcd Cluster<br/>2379/tcp]
            SCHEDULER[‚öôÔ∏è Scheduler]
            CONTROLLER[üéõÔ∏è Controller Manager]
        end

        subgraph "üìä Monitoring Tier (10.0.4.0/24)"
            PROMETHEUS[üìä Prometheus<br/>9090/tcp]
            GRAFANA_SVC[üìà Grafana Service<br/>3000/tcp]
            ALERTMANAGER[üö® AlertManager<br/>9093/tcp]
            LOKI[üìù Loki Logs<br/>3100/tcp]
        end

        subgraph "üîí Secret Management (10.0.5.0/24)"
            VAULT_SVC[üîê HashiCorp Vault<br/>8200/tcp]
            SEALED_SECRET_CTRL[üì¶ Sealed Secrets<br/>Controller]
            EXTERNAL_SECRET_OP[üîó External Secrets<br/>Operator]
        end
    end

    subgraph "üè¢ Corporate Network (Private)"
        LDAP_SERVER[üìÅ LDAP/AD Server<br/>389/636/tcp]
        SIEM_SYSTEM[üîç SIEM System<br/>Security Analytics]
        BACKUP_SYSTEM[üíø Backup Server<br/>Encrypted Backups]
    end

    %% User Access Flows
    USER --> LB
    ADMIN --> VPN_GW
    DEVELOPER --> VPN_GW

    %% DMZ to Cluster
    LB --> WAF
    WAF --> NGINX_INGRESS
    VPN_GW --> API_SERVER

    %% Ingress to Services
    NGINX_INGRESS --> KC_SVC
    NGINX_INGRESS --> GRAFANA_SVC
    CERT_MANAGER --> NGINX_INGRESS

    %% Service Discovery
    KC_SVC --> KC_POD_1
    KC_SVC --> KC_POD_2
    KC_SVC --> KC_POD_3

    %% Database Connectivity
    KC_POD_1 --> POSTGRES_SVC
    KC_POD_2 --> POSTGRES_SVC
    KC_POD_3 --> POSTGRES_SVC
    POSTGRES_SVC --> POSTGRES_MASTER
    POSTGRES_MASTER --> POSTGRES_REPLICA
    POSTGRES_MASTER --> PVC_STORAGE

    %% Control Plane
    KC_POD_1 --> API_SERVER
    KC_POD_2 --> API_SERVER
    KC_POD_3 --> API_SERVER
    API_SERVER --> ETCD
    API_SERVER --> SCHEDULER
    API_SERVER --> CONTROLLER

    %% Monitoring Flows
    KC_POD_1 --> PROMETHEUS
    KC_POD_2 --> PROMETHEUS
    KC_POD_3 --> PROMETHEUS
    POSTGRES_MASTER --> PROMETHEUS
    PROMETHEUS --> GRAFANA_SVC
    PROMETHEUS --> ALERTMANAGER

    %% Secret Management
    KC_POD_1 --> VAULT_SVC
    KC_POD_2 --> VAULT_SVC
    KC_POD_3 --> VAULT_SVC
    VAULT_SVC --> SEALED_SECRET_CTRL
    SEALED_SECRET_CTRL --> EXTERNAL_SECRET_OP

    %% External Integrations
    KC_POD_1 --> LDAP_SERVER
    KC_POD_2 --> LDAP_SERVER
    KC_POD_3 --> LDAP_SERVER
    PROMETHEUS --> SIEM_SYSTEM
    LOKI --> SIEM_SYSTEM
    POSTGRES_MASTER --> BACKUP_SYSTEM

    %% Network Policies (Security Boundaries)
    NGINX_INGRESS -.->|üöß Network Policy| KC_SVC
    KC_SVC -.->|üöß Network Policy| POSTGRES_SVC
    KC_SVC -.->|üöß Network Policy| VAULT_SVC
    PROMETHEUS -.->|üöß Network Policy| KC_SVC

    %% Port and Protocol Labels
    LB -.->|"üîå HTTPS:443<br/>HTTP:80"| WAF
    NGINX_INGRESS -.->|"üîå HTTP:8080"| KC_SVC
    KC_SVC -.->|"üîå PostgreSQL:5432"| POSTGRES_SVC
    KC_SVC -.->|"üîå HTTPS:8200"| VAULT_SVC
    PROMETHEUS -.->|"üîå HTTP:8080/metrics"| KC_SVC

    %% Network Zones
    classDef internetZone fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef dmzZone fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef ingressZone fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef identityZone fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef dataZone fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef controlZone fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    classDef monitoringZone fill:#fce4ec,stroke:#ad1457,stroke-width:2px
    classDef secretZone fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef corporateZone fill:#f9fbe7,stroke:#689f38,stroke-width:2px

    class USER,ADMIN,DEVELOPER internetZone
    class LB,WAF,VPN_GW dmzZone
    class NGINX_INGRESS,CERT_MANAGER ingressZone
    class KC_SVC,KC_POD_1,KC_POD_2,KC_POD_3 identityZone
    class POSTGRES_SVC,POSTGRES_MASTER,POSTGRES_REPLICA,PVC_STORAGE dataZone
    class API_SERVER,ETCD,SCHEDULER,CONTROLLER controlZone
    class PROMETHEUS,GRAFANA_SVC,ALERTMANAGER,LOKI monitoringZone
    class VAULT_SVC,SEALED_SECRET_CTRL,EXTERNAL_SECRET_OP secretZone
    class LDAP_SERVER,SIEM_SYSTEM,BACKUP_SYSTEM corporateZone
```

### üî¨ Matriz de Conectividade

| Origem | Destino | Porto | Protocolo | Pol√≠tica | Descri√ß√£o |
|--------|---------|-------|-----------|----------|-----------|
| **Internet** | Load Balancer | 443/80 | HTTPS/HTTP | ‚úÖ Allow | Acesso p√∫blico |
| **Admin VPN** | Kubernetes API | 6443 | HTTPS | ‚úÖ Allow | Administra√ß√£o |
| **Ingress** | Keycloak Service | 8080 | HTTP | ‚úÖ Allow | Aplica√ß√£o |
| **Keycloak** | PostgreSQL | 5432 | TCP | ‚úÖ Allow | Banco de dados |
| **Keycloak** | LDAP Server | 636 | LDAPS | ‚úÖ Allow | Identity Federation |
| **Keycloak** | Vault | 8200 | HTTPS | ‚úÖ Allow | Secret Management |
| **Prometheus** | Keycloak | 8080 | HTTP | ‚úÖ Allow | M√©tricas |
| **Keycloak** ‚Üí **Keycloak** | - | - | - | üö´ Deny | Isolamento lateral |
| **External** ‚Üí **PostgreSQL** | 5432 | TCP | - | üö´ Deny | Acesso direto negado |
| **Internet** ‚Üí **Kubernetes API** | 6443 | HTTPS | - | üö´ Deny | Apenas VPN |

### üß™ Cen√°rios de Teste

#### **üîê Teste de Autentica√ß√£o**
```bash
# 1. Testar login via OIDC
curl -X POST "https://keycloak.example.com/realms/kubernetes/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=kubernetes" \
  -d "username=testuser" \
  -d "password=testpass"

# 2. Validar token JWT
kubectl auth can-i --list --token=$TOKEN
```

#### **üö´ Teste de Network Policies**
```bash
# 1. Verificar isolamento entre pods
kubectl exec -it keycloak-0 -- nc -zv keycloak-1 8080
# Esperado: Connection refused (devido ao isolamento)

# 2. Verificar acesso ao banco
kubectl exec -it keycloak-0 -- nc -zv postgresql-service 5432
# Esperado: Connection successful
```

#### **üîí Teste de RBAC**
```bash
# 1. Testar permiss√µes de cluster-admin
kubectl --token=$ADMIN_TOKEN get nodes

# 2. Testar permiss√µes de developer
kubectl --token=$DEV_TOKEN get pods -n development
kubectl --token=$DEV_TOKEN get pods -n production
# Esperado: Acesso negado para production
```

### ‚úÖ Checklist de Valida√ß√£o

#### **üîß Infraestrutura**
- [ ] Keycloak pods em estado "Running"
- [ ] PostgreSQL cluster saud√°vel
- [ ] Persistent volumes montados
- [ ] Services com endpoints v√°lidos
- [ ] Ingress com certificado SSL v√°lido

#### **üîê Seguran√ßa**
- [ ] HTTPS obrigat√≥rio habilitado
- [ ] Certificados TLS v√°lidos e n√£o expirados
- [ ] Network policies aplicadas
- [ ] Secrets criptografadas
- [ ] Logs de auditoria funcionando

#### **üéØ Funcionalidade**
- [ ] Login OIDC funcionando
- [ ] Group mapping correto
- [ ] RBAC policies aplicadas
- [ ] Token JWT v√°lido
- [ ] Logout funcionando

#### **üìä Monitoramento**
- [ ] M√©tricas sendo coletadas
- [ ] Dashboards funcionando
- [ ] Alertas configurados
- [ ] Logs centralizados
- [ ] Health checks passando

#### **üîÑ Alta Disponibilidade**
- [ ] M√∫ltiplas replicas do Keycloak
- [ ] PostgreSQL com replica
- [ ] Load balancing funcionando
- [ ] Failover autom√°tico testado
- [ ] Backup/restore validado

### üö® Troubleshooting

#### **üîç Comandos de Diagn√≥stico**
```bash
# Verificar status dos pods
kubectl get pods -n keycloak-system -o wide

# Verificar logs do Keycloak
kubectl logs -f keycloak-0 -n keycloak-system

# Verificar configura√ß√£o do OIDC
kubectl get configmap keycloak-config -o yaml

# Testar conectividade de rede
kubectl exec -it keycloak-0 -- nslookup postgresql-service

# Verificar certificados
kubectl get certificates -n keycloak-system
```

#### **üêõ Problemas Comuns**

| Problema | Causa Prov√°vel | Solu√ß√£o |
|----------|----------------|---------|
| **Login falha** | Token expirado | Renovar certificados |
| **RBAC negado** | Group mapping incorreto | Verificar mappers no Keycloak |
| **Pod CrashLoop** | Database indispon√≠vel | Verificar PostgreSQL |
| **SSL erro** | Certificado inv√°lido | Renovar com cert-manager |
| **Performance lenta** | Recursos insuficientes | Aumentar CPU/Memory |

## üìö Refer√™ncias

- [Documenta√ß√£o Oficial do Keycloak](https://www.keycloak.org/documentation)
- [Keycloak Kubernetes Examples](https://github.com/keycloak/keycloak-quickstarts)
- [Kubernetes OIDC Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens)
- [Keycloak REST API](https://www.keycloak.org/docs-api/latest/rest-api/index.html)
- [Keycloak Helm Chart](https://github.com/bitnami/charts/tree/master/bitnami/keycloak)

## üè∑Ô∏è Tags

`keycloak` `kubernetes` `oidc` `sso` `identity-management` `rbac` `authentication`

---

<div align="center">
  
## üìû Suporte e Contato

**Embracon Toolbox Team**  
üåê [toolbox-tech.embracon.com](https://toolbox-tech.embracon.com)  
üìß toolbox@embracon.com.br  
üîó [GitHub](https://github.com/toolbox-tech) | [LinkedIn](https://linkedin.com/company/embracon)

---

### üõ†Ô∏è Desenvolvido com ‚ù§Ô∏è pela Embracon Toolbox

<p align="center">
  <strong>üîê Keycloak Identity & Access Management üöÄ</strong><br>
  <em>üîë SSO ‚Ä¢ OIDC ‚Ä¢ RBAC Integration</em>
</p>

<img src="../../../img/tbx.png" alt="Toolbox Logo" width="100"/>

**¬© 2025 Embracon Toolbox. Todos os direitos reservados.**

</div>
